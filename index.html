<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Center</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>


<!-- LOGO SUPERIOR DIREITO -->
<a href="/" class="logo-top" title="Central Planning">
  <img src="https://centralplanning.github.io/FOTOS_DATA/logo.png" alt="Central Planning Logo" />
</a>

<div class="main-container">
  
  <!-- LADO ESQUERDO (UPLOAD) -->
  <div class="upload-section">
    
    <div class="upload">
      <div id="uploadNotice">
  ‚ö†Ô∏è    <strong>Aten√ß√£o:</strong> As fotos precisam ter como nome o n√∫mero do item.
        <br>Exemplo: <code>157766.png</code>
      </div>
      <div class="upload-files">
        <header>
          <p><i class="fa fa-cloud-upload"></i> <span class="up">Up</span><span class="load">load</span></p>
        </header>

        <div class="body" id="drop">
          <i class="fa fa-file-image pointer-none"></i>
          <p class="pointer-none">
            <b>Arraste e solte</b> imagens aqui <br />
            ou <a href="#" id="triggerFile">navegue</a> para selecionar
          </p>
          <input type="file" multiple accept="image/*" />
        </div>

        <footer>
          <div class="divider"><span>ARQUIVOS</span></div>
          <div class="list-files"></div>
          <button class="importar">ENVIAR</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- LADO DIREITO (GALERIA) -->
  <div class="gallery-section">
    <div class="gallery" id="gallery">
      <h3>üìÅ Galeria de fotos</h3>
      <input type="text" id="searchInput" placeholder="Buscar por nome..." />
      <ul id="fileList"></ul>
      <!-- Bot√£o de download XLSX -->
        <div id="gallery-download" class="download-wrap">
          <button id="btnXlsx" class="dl2" type="button" aria-live="polite">
            <!-- √çcones: seta (default) e check (feito) -->
            <span class="dl2__icon">
              <svg class="i i-download" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 3a1 1 0 0 1 1 1v10.17l3.59-3.58a1 1 0 1 1 1.41 1.42l-5.3 5.3a1 1 0 0 1-1.41 0l-5.3-5.3a1 1 0 1 1 1.41-1.42L11 14.17V4a1 1 0 0 1 1-1Z"/>
                <path d="M4 19a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H5a1 1 0 0 1-1-1Z"/>
              </svg>
              <svg class="i i-check" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M20.29 7.29a1 1 0 0 1 0 1.42l-9 9a1 1 0 0 1-1.42 0l-4-4a1 1 0 0 1 1.42-1.42L10 15.17l8.58-8.58a1 1 0 0 1 1.41 0Z"/>
              </svg>
            </span>

            <span class="dl2__text" id="dl2Label">Baixar XLSX</span>

            <!-- Barra de progresso -->
            <span class="dl2__bar" aria-hidden="true">
              <span id="dl2Bar"></span>
            </span>
          </button>
        </div>

    </div>
  </div>
</div>

<!-- MODAL DE CARREGAMENTO -->
<div id="loadingModal" class="loading-modal hidden">
  <div class="modal-content">
    <div class="avatar-container">
      <img 
        src="https://centralplanning.github.io/FOTOS_DATA/logo-dark.png"
        alt="loading-avatar"
        class="avatar-bounce"
      >
    </div>
    <p id="loadingText">Carregando imagens...</p>
    <div class="progress-bar-wrapper">
      <div class="progress-bar-inner" id="progressInner"></div>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMA√á√ÉO -->
<div id="confirmModal" class="hidden modal-overlay">
  <div class="modal-content fade-in">
    <h3 id="confirmText">Deseja excluir este arquivo?</h3>
    <div class="modal-buttons">
      <button id="cancelDelete" class="cancel-btn">Cancelar</button>
      <button id="confirmDelete" class="confirm-btn">Excluir</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.min.js"></script>
<script src="script.js"></script>
<div class="bottom-progress" id="bottomProgress" style="
  position:fixed;
  bottom:18px;
  right:22px;
  color:#fff;
  font-size:14px;
  font-family:Inter, sans-serif;
  background:rgba(0,0,0,0.7);
  padding:8px 14px;
  border-radius:8px;
  backdrop-filter:blur(4px);
  z-index:9999;
  transition:opacity .3s ease;
  opacity:0;">
üì∏ 0 / 0 ‚Äî Aguardando imagens...
</div>

<script type="module">
/**
 * Exportar galeria em XLSX
 * Compat√≠vel com window.state.items carregado pelo script principal
 * Requer: https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm
 */

const btn   = document.getElementById('btnXlsx');
const bar   = document.getElementById('dl2Bar');
const label = document.getElementById('dl2Label');

let running = false;

/* === Utilidades === */
function setProgress(p){ 
  const pct = Math.max(0, Math.min(1, p));
  bar.style.width = (pct * 100).toFixed(2) + '%';
}
function nextFrame(){ 
  return new Promise(r => requestAnimationFrame(() => r())); 
}

/* === Estados do bot√£o === */
function setBusy(text='Gerando arquivo...'){
  running = true;
  btn.classList.add('is-busy');
  label.textContent = text;
  setProgress(0);
}
function setDone(text='Feito'){
  btn.classList.remove('is-busy');
  btn.classList.add('is-done');
  setProgress(1);
  label.textContent = text;
  setTimeout(() => {
    btn.classList.remove('is-done');
    label.textContent = 'Baixar XLSX';
    setProgress(0);
    running = false;
  }, 2500);
}
function setIdle(){
  btn.classList.remove('is-busy','is-done');
  label.textContent = 'Baixar XLSX';
  setProgress(0);
  running = false;
}

/* === Evento principal === */
btn.addEventListener('click', async (e) => {
  e.preventDefault();
  if (running) return;

  // ‚úÖ Captura global do state
  const globalState = window.state || {};
  const items = Array.isArray(globalState.items) ? globalState.items : [];
  if (!items.length){
    alert('Nenhuma imagem carregada para exportar.');
    return;
  }

  try{
    setBusy('Preparando dados...');
    await nextFrame();

    // === Monta dados ===
    const rows = [["Nome do Arquivo", "URL da Imagem"]];
    const total = items.length;
    const step = Math.max(500, Math.ceil(total / 40)); // ~40 atualiza√ß√µes de progresso

    for (let i = 0; i < total; i += step){
      const slice = items.slice(i, i + step);
      for (const obj of slice){
        const name = String(obj.name || '').replace(/\.webp$/i,'');
        rows.push([name, obj.url || '']);
      }
      setProgress(Math.min(0.8, (i + slice.length) / total * 0.8));
      await nextFrame();
    }

    // === Cria workbook ===
    label.textContent = 'Criando XLSX...';
    setProgress(0.85);
    const XLSX = await import('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm');
    await nextFrame();

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Galeria');

    label.textContent = 'Finalizando...';
    setProgress(0.95);
    await nextFrame();

    // === Gera e baixa ===
    const ab = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([ab], { type: 
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
    });

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const date = new Date().toISOString().slice(0,10);
    a.href = url;
    a.download = `galeria_fotos_${date}.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    setProgress(1);
    setDone('Feito');
  }catch(err){
    console.error(err);
    alert('Falha ao gerar o XLSX.');
    setIdle();
  }
});

/* === Garante acesso global === */
window.addEventListener('DOMContentLoaded', () => {
  if (window.state) {
    console.log('‚úÖ Exportador XLSX conectado √† galeria:', window.state.items?.length || 0, 'itens');
  } else {
    window.state = { items: [] };
    console.warn('‚ö†Ô∏è state global n√£o encontrado. Foi inicializado vazio.');
  }
});
</script>


</body>
</html>
